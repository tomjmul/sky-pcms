#!/bin/bash

# jira-get - Query Jira tickets using Firefox cookies
# Usage: jira-get DISCCMS-4415
#        jira-get --jql "project=DISCCMS AND status='In Progress'"

set -eo pipefail

# Configuration
FIREFOX_PROFILE="/Users/tommy/Library/Application Support/Firefox/Profiles/k2p85xj7.default-release"
JIRA_URL="https://gspcloud.atlassian.net"
COOKIES_DB="/tmp/cookies_jira_$$.sqlite"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Cleanup on exit
cleanup() {
    rm -f "$COOKIES_DB" /tmp/jira_request_$$.json /tmp/jira_response_$$.json
}
trap cleanup EXIT

# Show usage
usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] <TICKET_KEY|JQL|PRESET>

Query Jira tickets using Firefox session cookies.

Options:
    -h, --help              Show this help message
    -j, --jql JQL           Search using JQL query
    -f, --fields FIELDS     Comma-separated fields to retrieve
    -n, --max-results NUM   Maximum results for JQL search (default: 10)
    -c, --comments          Show comments
    -s, --subtasks          Show subtasks
    --json                  Output raw JSON instead of formatted text

Presets (quick shortcuts):
    mine                    All your assigned tickets
    review                  Your tickets in review
    progress                Your tickets in progress
    todo                    Your tickets to do
    recent                  Your recently updated tickets
    sprint                  Your current sprint tickets
    created                 Tickets you created recently
    watching                Tickets you're watching

Examples:
    $(basename "$0") DISCCMS-4415
    $(basename "$0") mine
    $(basename "$0") review -n 5
    $(basename "$0") sprint
    $(basename "$0") DISCCMS-4415 --comments
    $(basename "$0") --jql "project=DISCCMS AND status='In Progress'"
    $(basename "$0") DISCCMS-4415 --json

EOF
    exit 1
}

# Extract cookies from Firefox
extract_cookies() {
    if [[ ! -f "$FIREFOX_PROFILE/cookies.sqlite" ]]; then
        echo -e "${RED}Error: Firefox cookies database not found at $FIREFOX_PROFILE${NC}" >&2
        exit 1
    fi

    # Copy cookies to temp location (avoids database lock issues)
    cp "$FIREFOX_PROFILE/cookies.sqlite" "$COOKIES_DB" 2>/dev/null || {
        echo -e "${RED}Error: Could not copy cookies database. Is Firefox running?${NC}" >&2
        exit 1
    }

    # Extract tokens
    CLOUD_SESSION_TOKEN=$(sqlite3 "$COOKIES_DB" "SELECT value FROM moz_cookies WHERE host='auth.atlassian.com' AND name='cloud.session.token' LIMIT 1" 2>/dev/null || echo "")
    TENANT_SESSION_TOKEN=$(sqlite3 "$COOKIES_DB" "SELECT value FROM moz_cookies WHERE host='gspcloud.atlassian.net' AND name='tenant.session.token' LIMIT 1" 2>/dev/null || echo "")

    if [[ -z "$CLOUD_SESSION_TOKEN" || -z "$TENANT_SESSION_TOKEN" ]]; then
        echo -e "${RED}Error: Could not extract authentication tokens from Firefox.${NC}" >&2
        echo -e "${YELLOW}Make sure you're logged into Jira in Firefox.${NC}" >&2
        exit 1
    fi

    echo "cloud.session.token=$CLOUD_SESSION_TOKEN; tenant.session.token=$TENANT_SESSION_TOKEN"
}

# Query Jira API
query_jira() {
    local jql="$1"
    local fields="$2"
    local max_results="$3"
    local cookies="$4"

    # Escape quotes in JQL for JSON
    local escaped_jql=$(echo "$jql" | sed 's/"/\\"/g')

    cat > /tmp/jira_request_$$.json << EOF
{
  "jql": "$escaped_jql",
  "fields": [$(echo "$fields" | sed 's/,/","/g' | sed 's/^/"/' | sed 's/$/"/')],
  "maxResults": $max_results
}
EOF

    curl -s -H "Cookie: $cookies" \
        -H "Content-Type: application/json" \
        -X POST -d @/tmp/jira_request_$$.json \
        "$JIRA_URL/rest/api/3/search/jql" > /tmp/jira_response_$$.json

    # Check if response is empty
    if [[ ! -s /tmp/jira_response_$$.json ]]; then
        echo -e "${RED}Error: Empty response from Jira API${NC}" >&2
        echo -e "${YELLOW}The request may have failed. Check your network connection.${NC}" >&2
        exit 1
    fi

    # Check for errors
    if grep -q '"errorMessages"' /tmp/jira_response_$$.json 2>/dev/null; then
        echo -e "${RED}Error from Jira API:${NC}" >&2
        jq '.errorMessages' /tmp/jira_response_$$.json >&2
        exit 1
    fi

    cat /tmp/jira_response_$$.json
}

# Fetch and display comments for a ticket
show_comments() {
    local key="$1"
    local cookies="$2"

    echo -e "\n${BLUE}Fetching comments for $key...${NC}" >&2

    curl -s -H "Cookie: $cookies" \
        "https://gspcloud.atlassian.net/rest/api/3/issue/$key/comment" | \
    jq -r '
        if .comments and (.comments | length) > 0 then
            "
Comments (" + (.comments | length | tostring) + "):
" + (.comments[] |
                "--------------------------------------------------------------------------------
Author:  " + .author.displayName + " (" + .author.emailAddress + ")
Created: " + .created + "

" + (if .body then
                    # Extract text from ADF
                    (.body.content // [] | map(
                        if .type == "paragraph" and .content then
                            [.content[] | if .type == "text" then .text else "" end] | join("")
                        else
                            ""
                        end
                    ) | join("\n"))
                else
                    "No content"
                end) + "
")
        else
            "No comments"
        end
    '
}

# Fetch and display subtasks for a ticket
show_subtasks() {
    local key="$1"
    local cookies="$2"

    echo -e "\n${BLUE}Fetching subtasks for $key...${NC}" >&2

    local output=$(curl -s -H "Cookie: $cookies" \
        "https://gspcloud.atlassian.net/rest/api/3/issue/$key?fields=subtasks" | \
    jq -r '
        if .fields.subtasks and (.fields.subtasks | length) > 0 then
            "Subtasks (" + (.fields.subtasks | length | tostring) + "):\n" +
            ([.fields.subtasks[] |
                "  __JIRA_LINK__" + .key + "__\n    " + .fields.summary + " [" + .fields.status.name + "]"
            ] | join("\n\n"))
        else
            "No subtasks"
        end
    ')

    while IFS= read -r line; do
        if [[ "$line" =~ __JIRA_LINK__([A-Z]+-[0-9]+)__ ]]; then
            local subtask_key="${BASH_REMATCH[1]}"
            local url="https://gspcloud.atlassian.net/browse/$subtask_key"
            printf '  \x1b]8;;%s\x1b\\%s\x1b]8;;\x1b\\\n' "$url" "$url"
        else
            echo "$line"
        fi
    done < <(echo "$output")
}

# Format output for single ticket
format_ticket() {
    local output=$(jq -r '
        # Function to extract text from ADF recursively with formatting
        def extract_adf_text:
            if type == "object" then
                if .type == "text" then
                    .text
                elif .type == "paragraph" and .content then
                    ([.content[] | extract_adf_text] | join("")) + "\n"
                elif .type == "heading" and .content then
                    "\n" + ([.content[] | extract_adf_text] | join("")) + "\n"
                elif .type == "hardBreak" then
                    "\n"
                elif .content then
                    [.content[] | extract_adf_text] | join("")
                else
                    ""
                end
            elif type == "array" then
                [.[] | extract_adf_text] | join("")
            else
                ""
            end;

        .issues[] |
        # Extract description from customfield_11171 (ADF), description field, or renderedFields
        (if .fields.customfield_11171 then
            (.fields.customfield_11171 | extract_adf_text)
         elif .fields.description then
            (.fields.description | tostring)
         elif .renderedFields.description and (.renderedFields.description | length) > 0 then
            .renderedFields.description
         else
            null
         end) as $desc |
        "
================================================================================
" + .key + ": " + .fields.summary + "
================================================================================
Type:       " + (.fields.issuetype.name // "N/A") + "
Status:     " + (.fields.status.name // "N/A") + "
Priority:   " + (.fields.priority.name // "N/A") + "
" + (if .fields.assignee then "Assignee:   " + .fields.assignee.displayName + " (" + .fields.assignee.emailAddress + ")" else "Assignee:   Unassigned" end) + "
" + (if .fields.reporter then "Reporter:   " + .fields.reporter.displayName + " (" + .fields.reporter.emailAddress + ")" else "" end) + (if .fields.reporter then "
" else "" end) + "Created:    " + (.fields.created // "N/A") + "
Updated:    " + (.fields.updated // "N/A") +
(if (.fields.labels | length) > 0 then "
Labels:     " + (.fields.labels | join(", ")) else "" end) +
(if (.fields.components | length) > 0 then "
Components: " + ([.fields.components[].name] | join(", ")) else "" end) + "

Description:
" + (if $desc and ($desc | length) > 0 then $desc else "No description" end) + "

Link: __JIRA_LINK__" + .key + "__
================================================================================
"'
    )

    while IFS= read -r line; do
        if [[ "$line" =~ __JIRA_LINK__([A-Z]+-[0-9]+)__ ]]; then
            local key="${BASH_REMATCH[1]}"
            local url="https://gspcloud.atlassian.net/browse/$key"
            printf 'Link: \x1b]8;;%s\x1b\\%s\x1b]8;;\x1b\\\n' "$url" "$url"
        else
            echo "$line"
        fi
    done < <(echo "$output")
}

# Preset queries for Tom Muldoon
expand_preset() {
    local preset="$1"
    local user_email="tom.muldoon@sky.uk"

    case "$preset" in
        mine)
            echo "assignee = \"$user_email\" AND resolution = Unresolved ORDER BY updated DESC"
            ;;
        review)
            echo "assignee = \"$user_email\" AND status = 'In Review' ORDER BY updated DESC"
            ;;
        progress)
            echo "assignee = \"$user_email\" AND status = 'In Progress' ORDER BY updated DESC"
            ;;
        todo)
            echo "assignee = \"$user_email\" AND status = 'To Do' ORDER BY priority DESC, created DESC"
            ;;
        recent)
            echo "(assignee = \"$user_email\" OR reporter = \"$user_email\") AND updated >= -7d ORDER BY updated DESC"
            ;;
        sprint)
            echo "assignee = \"$user_email\" AND sprint in openSprints() ORDER BY priority DESC, updated DESC"
            ;;
        created)
            echo "reporter = \"$user_email\" AND created >= -14d ORDER BY created DESC"
            ;;
        watching)
            echo "watcher = \"$user_email\" ORDER BY updated DESC"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Parse arguments
JQL=""
FIELDS="summary,description,customfield_11171,status,assignee,issuetype,priority,created,updated,reporter,labels,fixVersions,components"
MAX_RESULTS=10
OUTPUT_JSON=false
SHOW_COMMENTS=false
SHOW_SUBTASKS=false
PRESET=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -j|--jql)
            JQL="$2"
            shift 2
            ;;
        -f|--fields)
            FIELDS="$2"
            shift 2
            ;;
        -n|--max-results)
            MAX_RESULTS="$2"
            shift 2
            ;;
        -c|--comments)
            SHOW_COMMENTS=true
            shift
            ;;
        -s|--subtasks)
            SHOW_SUBTASKS=true
            shift
            ;;
        --json)
            OUTPUT_JSON=true
            shift
            ;;
        -*)
            echo -e "${RED}Error: Unknown option: $1${NC}" >&2
            usage
            ;;
        *)
            # Check if it's a preset
            PRESET_JQL=$(expand_preset "$1")
            if [[ -n "$PRESET_JQL" ]]; then
                JQL="$PRESET_JQL"
                PRESET="$1"
            elif [[ -z "$JQL" ]]; then
                # Assume it's a ticket key
                JQL="key=$1"
            else
                echo -e "${RED}Error: Unexpected argument: $1${NC}" >&2
                usage
            fi
            shift
            ;;
    esac
done

# Validate input
if [[ -z "$JQL" ]]; then
    echo -e "${RED}Error: No ticket key or JQL query provided${NC}" >&2
    usage
fi

# Main execution
echo -e "${BLUE}Extracting cookies from Firefox...${NC}" >&2
COOKIES=$(extract_cookies)

echo -e "${BLUE}Querying Jira API...${NC}" >&2
RESPONSE=$(query_jira "$JQL" "$FIELDS" "$MAX_RESULTS" "$COOKIES")

if [[ -z "$RESPONSE" ]]; then
    echo -e "${RED}Error: No response received from Jira${NC}" >&2
    exit 1
fi

# Debug output
if [[ "${DEBUG:-}" == "1" ]]; then
    echo "Response length: ${#RESPONSE}" >&2
    echo "First 200 chars: ${RESPONSE:0:200}" >&2
fi

if [[ "$OUTPUT_JSON" == "true" ]]; then
    echo "$RESPONSE" | jq '.'
else
    echo "$RESPONSE" | format_ticket

    # If it's a single ticket (not a preset search), show comments/subtasks if requested
    if [[ "$JQL" =~ ^key= ]] && [[ -z "$PRESET" ]]; then
        TICKET_KEY=$(echo "$JQL" | sed 's/key=//')

        if [[ "$SHOW_SUBTASKS" == "true" ]]; then
            show_subtasks "$TICKET_KEY" "$COOKIES"
        fi

        if [[ "$SHOW_COMMENTS" == "true" ]]; then
            show_comments "$TICKET_KEY" "$COOKIES"
        fi
    fi
fi
